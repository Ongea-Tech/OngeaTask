<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>My To-Do List</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='dist/output.css') }}">
  <!-- <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" /> -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  {% block head %}{% endblock %}
</head>

<body class="h-screen w-screen overflow-hidden">

  <nav class="flex items-center justify-between bg-white px-4 py-2 shadow-md top-0 left-0 right-0 h-20 fixed">
    <a href="{{ url_for('routes.index') }}" class="flex items-center space-x-2">
      <img src="{{ url_for('static', filename='/images/logo.png') }}" alt="OngeaTask Logo" class="h-12 w-auto" />
    </a>

    <form class="relative w-1/3" action="/search" method="GET">
      <span class="absolute inset-y-0 left-3 flex items-center text-gray-400">
        <i class="fa-solid fa-magnifying-glass"></i>
      </span>
      <input type="text" name="q" placeholder="Search"
        class="w-full rounded-full border bg-gray-100 pl-10 pr-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
    </form>

    <div class="relative">

      <button id="profile-btn" class="flex items-center space-x-2 focus:outline-none">
        <img src="{{ url_for('static', filename='/images/profile.png') }}" alt="Profile"
          class="h-10 w-10 rounded-full cursor-pointer" />
        <span class="text-gray-700 font-medium">{{ user.name if user else 'User' }}</span>
      </button>


      <div id="dropdown-menu"
        class="hidden absolute right-0 mt-2 w-40 bg-white border border-gray-200 rounded-lg shadow-lg py-2 z-50">
        <a href="{{ url_for('routes.profile') }}" class="block px-4 py-2 text-gray-700 hover:bg-gray-100">Profile</a>
        <a href="{{ url_for('routes.logout') }}" class="block px-4 py-2 text-gray-600 hover:bg-gray-100">Logout</a>
      </div>
    </div>
  </nav>


  <div class="flex flex-1 pt-20">

    <div class="w-56 bg-white text-black flex flex-col justify-between fixed top-20 left-0 bottom-0 ">
      <div class="space-y-6 pt-6">
        <a href="{{ url_for('routes.index') }}"
          class="flex items-center py-2 pl-6 pr-1 gap-x-3 text-gray-700 hover:text-blue-600"><i
            class="fa-solid fa-list-check"></i>Tasks</a>
        <a href="{{ url_for('routes.categories') }}"
          class="flex items-center py-2 pl-6 pr-1 gap-x-3 text-gray-700 hover:text-blue-600"><i
            class="fa-solid fa-layer-group"></i>Categories</a>
        <a href="{{ url_for('routes.profile') }}"
          class="flex items-center py-2 pl-6 pr-1 gap-x-3 text-gray-700 hover:text-blue-600"><i
            class="fa-solid fa-user"></i>Profile</a>
        <a href="{{ url_for('routes.history') }}"
          class="flex items-center py-2 pl-6 pr-1 gap-x-3 text-gray-700 hover:text-blue-600"><i
            class="fa-solid fa-clock-rotate-left"></i>History</a>
        <!-- <a class="bg-red-700" href="{{ url_for('routes.history') }}"><i class="fa-solid fa-clock-rotate-left"></i>History</a> -->
      </div>

      <div class="mb-6">
        <a href="{{ url_for('routes.trash') }}"
          class="flex items-center py-2 pl-6 pr-1 gap-x-3 text-gray-700 hover:text-red-600"><i
            class="fa-solid fa-trash"></i>Trash</a>
        <a href="{{ url_for('routes.settings') }}"
          class="flex items-center py-2 pl-6 pr-1 gap-x-3 text-gray-700 hover:text-blue-600"><i
            class="fa-solid fa-gear"></i>Settings</a>
        <a href="{{ url_for('routes.logout') }}"
          class="flex items-center py-2 pl-6 pr-1 gap-x-3 text-gray-700 hover:text-red-600"><i
            class="fa-solid fa-right-from-bracket"></i>Logout</a>
      </div>
    </div>

    <main class="flex-1 ml-56 h-screen p-6 bg-gray-200 overflow-y-auto">
      {% block content %}

      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-semibold text-gray-800">Ongoing Tasks</h2>
        <button id="openModalBtn" class="bg-[#4379EE] text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition">
          Add New Task
        </button>
      </div>

      <div id="taskModal"
        class="fixed inset-0 backdrop-blur-sm bg-opacity-60 flex justify-center items-center hidden z-50">
        <div class="bg-white rounded-2xl shadow-2xl px-10 py-8 w-full max-w-md relative border-2 border-gray-200">
          <span id="closeModalBtn"
            class="absolute top-3 right-4 text-gray-500 text-2xl cursor-pointer hover:text-red-500">&times;</span>

          <form id="createTaskForm" method="POST" action="{{ url_for('routes.create_task') }}" class="space-y-5">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 text-center">Create New Task</h2>
            <div>
              <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Task Name (required):</label>
              <input type="text" id="name" name="name" required
                class="block w-full border border-gray-400 rounded-lg px-4 py-3 text-gray-700 focus:ring-[#4379EE] focus:border-[#4379EE]" />
            </div>
            <div>
              <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Description:</label>
              <textarea id="description" name="description"
                class="block w-full border border-gray-400 rounded-lg px-4 py-3 text-gray-700 resize-none focus:ring-[#4379EE] focus:border-[#4379EE] pb-3 "></textarea>
            </div>
            <div>
              <button type="submit"
                class="w-full bg-[#4379EE] rounded-lg py-3 hover:bg-blue-600 transition font-medium text-white bottom-2">Create
                Task</button>
            </div>
          </form>
        </div>
      </div>

      <div id="bulk-actions" class="flex items-center space-x-4 mb-4 hidden">
        <label class="flex items-center space-x-2">
          <input type="checkbox" id="selectAll"
            class="ml-4 w-5 h-5 accent-[#4379EE] rounded cursor-pointer self-center">
          <span class="text-gray-700 text-sm font-medium">Select All</span>
        </label>
        <form id="markCompletedForm" method="POST" action="{{ url_for('routes.mark_completed') }}">
          <input type="hidden" name="completed_ids" id="completedTaskIds">
          <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition">Mark
            as Completed</button>

        </form>

        <form id="moveToTrashForm" method="POST" action="{{ url_for('routes.move_to_trash') }}">
          <input type="hidden" name="trash_ids" id="trashTaskIds">
          <button type="submit" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition">üóëÔ∏è Move
            to Trash</button>
        </form>
      </div>

      <div class="space-y-4" id="taskList">
      </div>
      <script>
        const profileBtn = document.getElementById("profile-btn");
        const dropdownMenu = document.getElementById("dropdown-menu");

        profileBtn.addEventListener("click", () => {
          dropdownMenu.classList.toggle("hidden");
        });

        // Optional: Hide dropdown when clicking outside
        window.addEventListener("click", (e) => {
          if (!profileBtn.contains(e.target)) {
            dropdownMenu.classList.add("hidden");
          }
        });
      </script>
      <script>
        const modal = document.getElementById("taskModal");
        const openBtn = document.getElementById("openModalBtn");
        const closeBtn = document.getElementById("closeModalBtn");

        openBtn.onclick = () => {
          modal.style.display = "flex";
        };

        closeBtn.onclick = () => {
          modal.style.display = "none";
        };

        // Close modal if user clicks outside the modal content
        window.onclick = (event) => {
          if (event.target === modal) {
            modal.style.display = "none";
          }
        };
      </script>

      <script>
        document.addEventListener('DOMContentLoaded', function () {
          const bulkActions = document.getElementById('bulk-actions');
          const completedInput = document.getElementById('completedTaskIds');
          const trashInput = document.getElementById('trashTaskIds');
          const selectedTaskIds = new Set();

          function updateBulkActionsVisibility() {
            if (selectedTaskIds.size > 0) {
              bulkActions.style.display = 'flex';
            } else {
              bulkActions.style.display = 'none';
            }
          }

          fetch('/api/tasks')
            .then(response => response.json())
            .then(tasks => {
              const taskList = document.getElementById('taskList');
              taskList.innerHTML = ''; // Clear existing content

              tasks.forEach(task => {
                const completedSubtasks = task.subtasks.filter(st => st.completed).length;
                const totalSubtasks = task.subtasks.length;

                // Create the card
                const taskCard = document.createElement('div');
                taskCard.className = 'flex items-stretch justify-between bg-white rounded-lg shadow-md hover:shadow-md transition-shadow border border-gray-200 hover:border-blue-400 cursor-pointer h-24 mb-4';
                taskCard.style.cursor = 'pointer';
                taskCard.addEventListener('click', () => {
                  window.location.href = `/${task.id}`;
                });

                // Create the checkbox
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'ml-4 w-5 h-5 accent-[#4379EE] rounded cursor-pointer self-center';
                checkbox.dataset.taskId = task.id;

                // Prevent checkbox click from triggering card navigation
                checkbox.addEventListener('click', event => {
                  event.stopPropagation();
                });

                // Track selected tasks
                checkbox.addEventListener('change', () => {
                  const taskId = checkbox.dataset.taskId;
                  if (checkbox.checked) {
                    selectedTaskIds.add(taskId);
                  } else {
                    selectedTaskIds.delete(taskId);
                  }
                  updateBulkActionsVisibility();
                });
                const selectAllCheckbox = document.getElementById('selectAll');

                selectAllCheckbox.addEventListener('change', () => {
                  const allCheckboxes = document.querySelectorAll('#taskList input[type="checkbox"]');

                  allCheckboxes.forEach(checkbox => {
                    checkbox.checked = selectAllCheckbox.checked;
                    const taskId = checkbox.dataset.taskId;

                    if (selectAllCheckbox.checked) {
                      selectedTaskIds.add(taskId);
                    } else {
                      selectedTaskIds.delete(taskId);
                    }
                  });

                  updateBulkActionsVisibility();
                });


                // Task info section
                const taskInfo = document.createElement('div');
                taskInfo.className = 'justify-center flex-1';
                taskInfo.innerHTML = `
                            <span class="inline-block text-xs font-medium text-gray-600 bg-gray-100 px-2 py-1 rounded mb-2">General</span>
                            <div>
                                <h4 class="text-lg font-semibold text-gray-800">${task.title}</h4>
                                <p class="text-sm text-gray-500">${completedSubtasks}/${totalSubtasks} completed</p>
                            </div>
                        `;
                const priorityIndicator = document.createElement('div');
                priorityIndicator.className = 'w-5 rounded-r-lg bg-green-400 ml-4'
                
                taskCard.appendChild(checkbox);
                taskCard.appendChild(taskInfo);
                taskList.appendChild(taskCard);
                taskCard.appendChild(priorityIndicator);
              });
            })
            .catch(error => {
              console.error('Error fetching tasks:', error);
            });

          // Attach form submit handlers to pass selected task IDs
          document.getElementById('markCompletedForm').addEventListener('submit', function () {
            completedInput.value = Array.from(selectedTaskIds).join(',');
          });

          document.getElementById('moveToTrashForm').addEventListener('submit', function () {
            trashInput.value = Array.from(selectedTaskIds).join(',');
          });
        });
      </script>


      {% endblock %}
    </main>
  </div>
  {% block scripts %}
  <script src="{{ url_for('static', filename='individual-task.js') }}"></script>
  {% endblock %}

</body>

</html>