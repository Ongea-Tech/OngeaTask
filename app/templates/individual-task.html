{% extends "index.html" %}
{% block content %}

<div class="taskContainer" data-task-id="{{ task.id }}">
    <a href="{{ url_for('routes.index') }}"><i class="fa-solid fa-arrow-left"></i></a>

    <div class="title">
        <h2>{{ task.title }}</h2>
        <label class="category"></label>
    </div>

    <div class="description">
        <textarea placeholder="Add a description here...">{{ task.description }}</textarea>
    </div>

    <div class="check-all">
        <label class="checkbox">
            <input type="checkbox" id="checkAllBox" />
        </label>
        <button class="delete" id="deleteAllBtn">
            Delete all <a href="#" class="deleteIcon"><i class="fa-solid fa-trash-can"></i></a>
        </button>
    </div>

    <div class="subtasks" id="subtaskList">
        {% for subtask in task.subtasks %}
        <label class="checkbox" data-subtask-id="{{ subtask.id }}">
            <input type="checkbox" {% if subtask.completed %}checked{% endif %}>
            <p>{{ subtask.title }}</p>
            <a href="#" class="icon"><i class="fa-solid fa-trash-can"></i></a>
        </label>
        <br>
        {% endfor %}
    </div>

    <div class="addSubtask">
        <input type="text" placeholder="Add a new list item" id="subtaskInput">
        <button class="inputButton" id="addSubtaskBtn">Add</button>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const taskId = {{ task.id }};
    const subtaskList = document.getElementById("subtaskList");

    // Add subtask
    document.getElementById("addSubtaskBtn").addEventListener("click", async function () {
        const input = document.getElementById("subtaskInput");
        const subtaskText = input.value.trim();

        if (subtaskText === "") {
            alert("Please enter a new item.");
            return;
        }

        const response = await fetch(`/api/tasks/${taskId}/subtasks`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ title: subtaskText })
        });

        if (response.ok) {
            location.reload();
        } else {
            alert("Failed to add subtask.");
        }
    });

    // Delete individual subtask
    subtaskList.addEventListener("click", async function (event) {
        if (event.target.classList.contains("fa-trash-can")) {
            event.preventDefault();
            const label = event.target.closest(".checkbox");
            const subtaskId = label.getAttribute("data-subtask-id");

            if (confirm("Are you sure you want to delete this subtask?")) {
                const res = await fetch(`/api/subtasks/${subtaskId}`, { method: "DELETE" });
                if (res.ok) {
                    label.remove();
                } else {
                    alert("Failed to delete subtask.");
                }
            }
        }
    });

    // Check/uncheck all subtasks
    document.getElementById("checkAllBox").addEventListener("change", function () {
        const isChecked = this.checked;
        const checkboxes = subtaskList.querySelectorAll("input[type='checkbox']");
        checkboxes.forEach(cb => cb.checked = isChecked);
    });

    // Delete all subtasks
    document.getElementById("deleteAllBtn").addEventListener("click", async function (event) {
        event.preventDefault();

        const labels = subtaskList.querySelectorAll(".checkbox");
        if (!labels.length) return;

        const confirmDelete = confirm("Are you sure you want to delete all subtasks?");
        if (!confirmDelete) return;

        for (const label of labels) {
            const subtaskId = label.getAttribute("data-subtask-id");
            await fetch(`/api/subtasks/${subtaskId}`, { method: "DELETE" });
        }

        location.reload(); // Refresh to show empty state
    });
});
</script>

{% endblock %}
