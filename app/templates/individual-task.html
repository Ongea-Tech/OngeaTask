{% extends "index.html" %} {% block content %}

<div class="taskContainer max-w-full" data-task-id="{{ task.id }}">
  <a href="{{ url_for('routes.index') }}">
    <i class="fa-solid fa-arrow-left"></i>
  </a>

  <!-- Title -->
  <div class="title flex justify-between mb-[13px] w-full">
    <h2 class="font-bold mt-4 text-2xl">{{ task.title }}</h2>

    <!-- Category Dropdown -->
    <div class="category-dropdown relative inline-block">
      <label class="category" id="categoryLabel">Select Category</label>
      <div
        class="dropdown-menu hidden absolute bg-white border border-[#ccc] mt-[5px] py-[5px] z-10 rounded-[4px] shadow-[0_2px_5px_rgba(0,0,0,0.1)]"
        id="categoryMenu"
      >
        <div
          class="dropdown-option flex items-center gap-[8px] px-[12px] py-[6px] cursor-pointer"
          data-color="red"
        >
          <span
            class="color-circle inline-block w-[12px] h-[12px] rounded-full bg-red-500"
          ></span>
          High
        </div>
        <div
          class="dropdown-option flex items-center gap-[8px] px-[12px] py-[6px] cursor-pointer"
          data-color="grey"
        >
          <span
            class="color-circle inline-block w-[12px] h-[12px] rounded-full bg-gray-500"
          ></span>
          Medium
        </div>
        <div
          class="dropdown-option flex items-center gap-[8px] px-[12px] py-[6px] cursor-pointer"
          data-color="green"
        >
          <span
            class="color-circle inline-block w-[12px] h-[12px] rounded-full bg-[#4caf50]"
          ></span>
          Low
        </div>
      </div>
    </div>
  </div>

  <!-- Description -->
  <div class="description">
    <textarea
      id="descriptionBox"
      placeholder="Add a description here..."
      class="w-full flex h-[120px] p-[15px] border-none focus:outline-none bg-white"
    >{{ task.description }}</textarea>
    <button
      id="saveDescriptionBtn"
      class="save-button mt-[5px] px-[12px] py-[6px] bg-gray-500 text-white border-none rounded-[4px] text-[0.9rem] cursor-not-allowed opacity-60 relative left-0"
      disabled
    >
      Save
    </button>
  </div>

  <!-- Bulk Actions -->
  <div id="bulkActions" style="display: none" class="bulk-actions flex items-center gap-[10px] mt-[10px]">
    <button
      type="button"
      id="checkAllBtn"
      class="checkAll w-[20px] h-[20px] border border-gray-400 rounded-[3px] cursor-pointer"
    ></button>

    <form
      id="markCompletedForm"
      method="POST"
      action="{{ url_for('routes.mark_completed') }}"
      class="inline"
    >
      <input type="hidden" name="completed_ids" id="completedTaskIds" />
      <div>
        <button
          id="markCompleteBtn"
          class="markComplete px-[10px] py-[5px] bg-green-600 text-white rounded-[4px] text-[0.9rem] cursor-pointer"
          type="submit"
        >
          Mark as Completed
        </button>
      </div>
    </form>

    <form
      id="deleteSelectedForm"
      method="POST"
      action="{{ url_for('routes.delete_selected') }}"
      class="inline"
    >
      <input type="hidden" name="delete_ids" id="deleteTaskIds" />
      <button
        type="submit"
        id="deleteSelectedBtn"
        class="deleteSelected px-[10px] py-[6px] bg-red-600 text-white rounded-[4px] text-[0.9rem] cursor-pointer flex items-center gap-[5px]"
      >
        üóëÔ∏è Delete Selected
      </button>
    </form>
  </div>

  <!-- Subtasks -->
  <div class="subtasks mt-[15px]" id="subtaskList">
    {% for subtask in task.subtasks %}
    <label
      class="checkbox flex items-center justify-between border border-gray-200 rounded-[4px] p-[8px] mb-[5px]"
      data-subtask-id="{{ subtask.id }}"
    >
      <div class="flex items-center gap-[8px]">
        <input
          type="checkbox"
          class="w-[16px] h-[16px] accent-green-600 cursor-pointer"
          {% if subtask.completed %}checked{% endif %}
        />
        <p>{{ subtask.title }}</p>
      </div>
      <a href="#" class="icon text-gray-500 hover:text-red-600">
        <i class="fa-solid fa-trash-can"></i>
      </a>
    </label>
    {% endfor %}
  </div>

  <!-- Add Subtask -->
  <div class="addSubtask flex items-center gap-[8px] mt-[10px]" id="addSubtaskContainer">
    <button
      id="expandInputBtn"
      class="expand-btn text-xl text-gray-600 hover:text-black"
    >
      ‚ûï
    </button>
    <input
      type="text"
      placeholder="Add a new list item"
      id="subtaskInput"
      class="collapsed border border-gray-300 rounded-[4px] px-[10px] py-[6px] flex-1 focus:outline-none"
    />
    <button
      class="inputButton bg-blue-600 text-white px-[12px] py-[6px] rounded-[4px] text-[0.9rem] hover:bg-blue-700"
      id="addSubtaskBtn"
    >
      Add
    </button>
  </div>
</div>


<script>
      document.addEventListener("DOMContentLoaded", function () {
      const taskId = {{ task.id }};
      const subtaskList = document.getElementById("subtaskList");
      let allChecked = false;

      // Add subtask
      document.getElementById("addSubtaskBtn").addEventListener("click", async function () {
        const input = document.getElementById("subtaskInput");
        const subtaskText = input.value.trim();

        if (subtaskText === "") {
          alert("Please enter a new item.");
          return;
        }

        const response = await fetch(`/api/tasks/${taskId}/subtasks`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ title: subtaskText })
        });

        if (response.ok) {
          location.reload();
        } else {
          alert("Failed to add subtask.");
        }
      });

      // Delete individual subtask
      subtaskList.addEventListener("click", async function (event) {
        if (event.target.classList.contains("fa-trash-can")) {
          event.preventDefault();
          const label = event.target.closest(".checkbox");
          const subtaskId = label.getAttribute("data-subtask-id");

          if (confirm("Are you sure you want to delete this subtask?")) {
            const res = await fetch(`/api/subtasks/${subtaskId}`, { method: "DELETE" });
            if (res.ok) {
              label.remove();
            } else {
              alert("Failed to delete subtask.");
            }
          }
        }
      });

      // Show/hide bulk action bar when individual checkboxes change
      subtaskList.addEventListener("change", function () {
        const checkboxes = subtaskList.querySelectorAll("input[type='checkbox']");
        const anyChecked = Array.from(checkboxes).some(cb => cb.checked);
        document.getElementById("bulkActions").style.display = anyChecked ? "flex" : "none";
      });

      // Check All button toggle
      const checkAllBtn = document.getElementById("checkAllBtn");
      checkAllBtn.addEventListener("click", function () {
        const checkboxes = document.querySelectorAll("#subtaskList input[type='checkbox']");
        allChecked = !allChecked;
        checkboxes.forEach(cb => cb.checked = allChecked);
        checkAllBtn.textContent = allChecked ? "" : "";

        const anyChecked = Array.from(checkboxes).some(cb => cb.checked);
        document.getElementById("bulkActions").style.display = anyChecked ? "flex" : "none";
      });

     // Mark as completed
     document.getElementById("markCompletedForm").addEventListener("submit", async function (e) {
      e.preventDefault();

      const checkboxes = document.querySelectorAll("#subtaskList input[type='checkbox']:checked");
      const ids = Array.from(checkboxes).map(cb =>
        cb.closest(".checkbox").getAttribute("data-subtask-id")
      );

      if (ids.length === 0) {
        alert("Please select at least one subtask to mark as complete.");
        return;
      }

      // Send to backend
      const response = await fetch("{{ url_for('routes.mark_completed') }}", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ completed_ids: ids })
      });

      if (response.ok) {
        // Apply visual feedback: strikethrough
        checkboxes.forEach(cb => {
          const label = cb.closest(".checkbox");
          label.classList.add("completed");
          cb.checked = false;
        });

        // Hide bulk actions bar
        document.getElementById("bulkActions").style.display = "none";
      } else {
        alert("Failed to mark tasks as complete.");
      }
    });


      // Delete selected form handler
      document.getElementById("deleteSelectedForm").addEventListener("submit", function (e) {
        const checkboxes = document.querySelectorAll("#subtaskList input[type='checkbox']:checked");
        const ids = Array.from(checkboxes).map(cb => cb.closest(".checkbox").getAttribute("data-subtask-id"));

        if (ids.length === 0) {
          e.preventDefault();
          alert("Please select at least one subtask to delete.");
          return;
        }

        if (!confirm("Are you sure you want to delete selected subtasks?")) {
          e.preventDefault();
          return;
        }

        document.getElementById("deleteTaskIds").value = ids.join(",");
      });

      // Category dropdown functionality
      const categoryLabel = document.getElementById("categoryLabel");
      const categoryMenu = document.getElementById("categoryMenu");

      categoryLabel.addEventListener("click", function () {
        categoryMenu.style.display = categoryMenu.style.display === "block" ? "none" : "block";
      });

      categoryMenu.addEventListener("click", function (event) {
        const selectedColor = event.target.getAttribute("data-color");
        if (selectedColor) {
          categoryLabel.textContent = "";
          categoryLabel.style.backgroundColor = selectedColor;
          categoryMenu.style.display = "none";
        }
      });

      document.addEventListener("click", function (event) {
        if (!categoryLabel.contains(event.target) && !categoryMenu.contains(event.target)) {
          categoryMenu.style.display = "none";
        }
      });

      // Description save functionality
      const descriptionBox = document.getElementById("descriptionBox");
      const saveButton = document.getElementById("saveDescriptionBtn");
      let originalDescription = descriptionBox.value.trim();

      descriptionBox.addEventListener("input", function () {
        const currentText = descriptionBox.value.trim();
        if (currentText !== originalDescription) {
          saveButton.classList.add("active");
          saveButton.disabled = false;
        } else {
          saveButton.classList.remove("active");
          saveButton.disabled = true;
        }
      });

      saveButton.addEventListener("click", async function () {
        const newDescription = descriptionBox.value.trim();
        const response = await fetch(`/api/tasks/${taskId}/description`, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ description: newDescription })
        });

        if (response.ok) {
          originalDescription = newDescription;
          saveButton.classList.remove("active");
          saveButton.disabled = true;
        } else {
          alert("Failed to update description.");
        }
      });

      //Epanding Input field for adding subtasks
    const expandBtn = document.getElementById("expandInputBtn");
    const inputField = document.getElementById("subtaskInput");
    const addBtn = document.getElementById("addSubtaskBtn");

    expandBtn.addEventListener("click", () => {
    inputField.classList.toggle("expanded");
    inputField.classList.toggle("collapsed");
    inputField.focus();
    });

  addBtn.addEventListener("click", () => {
    const value = inputField.value.trim();
    if (value === "") {
      alert("Subtask cannot be empty!");
      return;
    }

    // Add your subtask-adding logic here
    console.log("Subtask added:", value);

    inputField.value = "";
    inputField.classList.remove("expanded");
    inputField.classList.add("collapsed");
  });


});
</script>
{% endblock %}
