{% extends "index.html" %} 
{% block content %}

<div class="categories-page">
  <h2 class="categories-title">Categories</h2>
  <div class="delete-header">
    <input type="checkbox" class="category-checkbox" id="select-all-checkbox" />
    <button class="delete-all-button">Delete All</button>
  </div>

  <form class="category-form">
    {% for category in categories %}
    <div class="category-group" data-id="{{ category.id }}">
      <input type="checkbox" class="category-checkbox" />
      <span class="color-indicator" style="background-color: '{{ category.color }}';"></span>
      <input type="text" class="category-input" value="{{ category.name }}" readonly />
      <div class="category-actions">
        <span class="delete-icon">&#128465;</span>
        <span class="edit-icon">&#9998;</span>
      </div>
    </div>
    {% endfor %}

    <button class="add-category-button">Add Category</button>
  </form>
</div>


<div id="category-modal" class="modal hidden">
  <div class="modal-content">
    <h3 id="modal-title">Add Category</h3>
    <label for="category-name">Category Name:</label>
    <input type="text" id="category-name" class="large-input" />

    <label for="category-color">Pick Priority Color:</label>
    <div class="color-row">
      <input type="color" id="category-color" value="#cccccc" />
      <div class="preset-colors">
        <span class="color-swatch" data-color="#ff4d4f" style="background-color: #ff4d4f;"></span>
        <span class="color-swatch" data-color="#faad14" style="background-color: #faad14;"></span>
        <span class="color-swatch" data-color="#52c41a" style="background-color: #52c41a;"></span>
        <span class="color-swatch" data-color="#1890ff" style="background-color: #1890ff;"></span>
        <span class="color-swatch" data-color="#722ed1" style="background-color: #722ed1;"></span>
        <span class="color-swatch" data-color="#13c2c2" style="background-color: #13c2c2;"></span>
      </div>
    </div>

    

    <div class="modal-buttons">
      <button id="confirm-btn">OK</button>
      <button id="cancel-btn">Cancel</button>
    </div>
  </div>
</div>

<div id="confirm-delete-modal" class="modal hidden">
  <div class="modal-content">
    <h3 class="modal-title">Confirm Deletion</h3>
    <p>Are you sure you want to delete all selected categories?</p>
    <div class="modal-buttons">
      <button id="confirm-delete-btn">Yes, Delete</button>
      <button id="cancel-delete-btn">Cancel</button>
    </div>
  </div>
</div>

<div id="custom-alert" class="modal hidden">
  <div class="modal-content">
    <p id="alert-message"></p>
    <div class="modal-buttons">
      <button id="alert-ok-btn">OK</button>
    </div>
  </div>
</div>


<div id="custom-confirm" class="modal hidden">
  <div class="modal-content">
    <p id="confirm-message">Are you sure?</p>
    <div class="modal-buttons">
      <button id="confirm-yes-btn" class="confirm-yes">Yes</button>
      <button id="confirm-no-btn">Cancel</button>
    </div>
  </div>
</div>


<script>
  document.addEventListener("DOMContentLoaded", function () {
    const form = document.querySelector(".category-form");
    const addButton = document.querySelector(".add-category-button");
    const topDeleteBtn = document.querySelector(".delete-all-button");
    const topCheckbox = document.getElementById("select-all-checkbox");

    const modal = document.getElementById("category-modal");
    const modalTitle = document.getElementById("modal-title");
    const nameInput = document.getElementById("category-name");
    const colorInput = document.getElementById("category-color");
    const confirmBtn = document.getElementById("confirm-btn");
    const cancelBtn = document.getElementById("cancel-btn");

    const confirmDeleteModal = document.getElementById("confirm-delete-modal");
    const confirmDeleteBtn = document.getElementById("confirm-delete-btn");
    const cancelDeleteBtn = document.getElementById("cancel-delete-btn");

    const customAlert = document.getElementById("custom-alert");
    const alertMessage = document.getElementById("alert-message");
    const alertOkBtn = document.getElementById("alert-ok-btn");

    const customConfirm = document.getElementById("custom-confirm");
    const confirmMessage = document.getElementById("confirm-message");
    const confirmYesBtn = document.getElementById("confirm-yes-btn");
    const confirmNoBtn = document.getElementById("confirm-no-btn");

    let editingCategoryId = null;
    let idsToDelete = [];

    function showAlert(message) {
      alertMessage.textContent = message;
      customAlert.classList.remove("hidden");
      alertOkBtn.onclick = () => {
        customAlert.classList.add("hidden");
      };
    }

    function showConfirm(message, onConfirm) {
      confirmMessage.textContent = message;
      customConfirm.classList.remove("hidden");
      confirmYesBtn.onclick = () => {
        customConfirm.classList.add("hidden");
        onConfirm();
      };
      confirmNoBtn.onclick = () => {
        customConfirm.classList.add("hidden");
      };
    }

    function openCategoryModal(title, defaultName = "", defaultColor = "#cccccc") {
      modalTitle.textContent = title;
      modalTitle.classList.toggle("bold-title", title.toLowerCase().includes("edit"));
      nameInput.value = defaultName;
      colorInput.value = defaultColor;
      highlightActiveSwatch(defaultColor);
      modal.classList.remove("hidden");
    }

    function closeCategoryModal() {
      modal.classList.add("hidden");
      editingCategoryId = null;
    }

    confirmBtn.addEventListener("click", function () {
      const name = nameInput.value.trim();
      const color = colorInput.value;

      if (!name) return showAlert("Category name required");

      if (editingCategoryId) {
        fetch(`/api/categories/${editingCategoryId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, color })
        }).then(res => {
          if (res.ok) location.reload();
          else showAlert("Failed to update.");
        });
      } else {
        fetch("/api/categories", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, color })
        })
          .then(res => res.json())
          .then(data => {
            if (data.category_id) location.reload();
            else showAlert("Error creating category.");
          });
      }

      closeCategoryModal();
    });

    cancelBtn.addEventListener("click", closeCategoryModal);

    fetch('/api/categories')
      .then(res => res.json())
      .then(categories => {
        categories.forEach(renderCategoryGroup);
      });

    function renderCategoryGroup(category) {
      const div = document.createElement("div");
      div.className = "category-group";
      div.setAttribute("data-id", category.id);
      div.innerHTML = `
        <input type="checkbox" class="category-checkbox" />
        <span class="color-indicator" style="background-color: ${category.color};"></span>
        <input type="text" class="category-input" value="${category.name}" readonly />
        <div class="category-actions">
          <span class="delete-icon">&#128465;</span>
          <span class="edit-icon">&#9998;</span>
        </div>
      `;
      form.insertBefore(div, addButton);

      const editBtn = div.querySelector(".edit-icon");
      const deleteBtn = div.querySelector(".delete-icon");

      editBtn.addEventListener("click", function () {
        editingCategoryId = category.id;
        openCategoryModal("Edit Category", category.name, category.color);
      });

      deleteBtn.addEventListener("click", function () {
        const id = div.dataset.id;
        showConfirm("Are you sure you want to delete this category?", () => {
          fetch(`/api/categories/${id}`, {
            method: "DELETE"
          }).then(res => {
            if (res.ok) div.remove();
            else showAlert("Failed to delete.");
          });
        });
      });
    }

    function highlightActiveSwatch(color) {
      document.querySelectorAll('.color-swatch').forEach(swatch => {
        swatch.classList.remove('active');
        if (swatch.dataset.color.toLowerCase() === color.toLowerCase()) {
          swatch.classList.add('active');
        }
      });
    }

    colorInput.addEventListener("input", () => {
      highlightActiveSwatch(colorInput.value);
    });

    document.querySelectorAll('.color-swatch').forEach(swatch => {
      swatch.addEventListener('click', function () {
        const selectedColor = this.dataset.color;
        colorInput.value = selectedColor;
        highlightActiveSwatch(selectedColor);
      });
    });

    addButton.addEventListener("click", function (e) {
      e.preventDefault();
      editingCategoryId = null;
      openCategoryModal("Add Category");
    });

    if (topCheckbox) {
      topCheckbox.addEventListener("change", function () {
        const allCheckboxes = document.querySelectorAll(".category-group .category-checkbox");
        allCheckboxes.forEach(cb => cb.checked = topCheckbox.checked);
      });
    }

    if (topDeleteBtn) {
      topDeleteBtn.addEventListener("click", function (e) {
        e.preventDefault();
        const selectedGroups = Array.from(document.querySelectorAll(".category-group")).filter(group => {
          const checkbox = group.querySelector(".category-checkbox");
          return checkbox && checkbox.checked;
        });

        if (selectedGroups.length === 0) {
          showAlert("Please select at least one category to delete.");
          return;
        }

        idsToDelete = selectedGroups.map(group => group.dataset.id);
        confirmDeleteModal.classList.remove("hidden");
      });
    }

    confirmDeleteBtn.addEventListener("click", function () {
      fetch("/api/categories/delete-multiple", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ids: idsToDelete })
      })
        .then(response => response.json())
        .then(data => {
          if (data.deleted_ids) {
            idsToDelete.forEach(id => {
              const group = document.querySelector(`.category-group[data-id="${id}"]`);
              if (group) group.remove();
            });
          } else {
            showAlert("Failed to delete categories.");
          }
          confirmDeleteModal.classList.add("hidden");
        })
        .catch(error => {
          console.error("Error:", error);
          showAlert("An error occurred while deleting.");
          confirmDeleteModal.classList.add("hidden");
        });
    });

    cancelDeleteBtn.addEventListener("click", function () {
      confirmDeleteModal.classList.add("hidden");
    });
  });
</script>




{% endblock %}