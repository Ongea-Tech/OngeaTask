{% extends "index.html" %}

{% block content %}
<div class="mb-5">
  <h1 class="text-3xl font-bold h-15">History</h1>
  <hr class="border-t border-gray-300">
</div>
<div class="h-6"></div>

{% if today_tasks or yesterday_tasks %}
  <!-- top controls -->
  <div class="flex items-center gap-15">
    <input type="checkbox" class="custom-checkbox master-checkbox w-15"/>

    <form method="POST" action="{{ url_for('routes.history_action') }}" class="inline">
      <input type="hidden" name="all_task_ids" id="all-task-ids"/>
      <button type="submit" name="action" value="reopen"
              class="text-white bg-gradient-to-r from-blue-500 via-blue-600 to-blue-700 hover:bg-gradient-to-br focus:ring-4 focus:ring-blue-300 font-medium rounded-sm text-base px-5 py-2.5 text-center cursor-pointer">
        Reopen Task
      </button>
    </form>

    <form method="POST" action="{{ url_for('routes.history_action') }}" class="inline">
      <input type="hidden" name="all_task_ids" id="all-delete-ids"/>
      <button type="submit" name="action" value="trash" aria-label="Move to trash"
              class="inline-flex items-center justify-center px-2 py-1 text-xl leading-none text-red-600 hover:text-red-700 border-0 bg-transparent focus:outline-none cursor-pointer">
        ðŸ—‘
      </button>
    </form>
  </div>
  <div class="h-6"></div>
{% endif %}

<!-- Today -->
{% if today_tasks %}
<section class="mb-8">
  <div class="flex justify-between items-center flex-wrap">
    <h2 class="text-2xl font-semibold h-8">
      Today ({{ today_date }})
    </h2>
  </div>
  <div class="h-8"></div>

  {% for task in today_tasks %}
  <div class="w-full h-24 bg-white rounded-lg shadow-sm flex items-center pr-4 pl-3 text-lg font-medium gap-4 mb-5">
    <input type="checkbox" name="task_ids" value="{{ task.id }}" class="task-checkbox custom-checkbox w-15"/>
    <div class="flex-grow">
      <span class="inline-block text-sm font-semibold py-1 px-2 rounded mb-0.5 text-gray-800
            {% if task.category | lower == 'home' %}bg-yellow-200
            {% elif task.category | lower == 'work' %}bg-red-200
            {% else %}bg-gray-200{% endif %}">
        {{ task.category }}
      </span>
      <p class="text-gray-800 leading-tight">
        {{ task.title }}<br/>
        <small class="text-gray-500 font-normal">{{ task.subtask_summary }}</small>
      </p>
    </div>
    <div class="w-2.5 h-full rounded-r-lg ml-auto -mr-4
          {% if task.color == 'red' %}bg-red-500
          {% elif task.color == 'yellow' %}bg-yellow-400
          {% elif task.color == 'gray' %}bg-neutral-400
          {% endif %}">
    </div>
  </div>
  <div class="h-6"></div>
  {% endfor %}
</section>
{% endif %}

<!-- Yesterday -->
{% if yesterday_tasks %}
<div class="h-1"></div>
<section class="mb-8">
  <div class="flex justify-between items-center flex-wrap">
    <h2 class="text-2xl font-semibold h-15">
      Yesterday ({{ yesterday_date }})
    </h2>
  </div>

  {% for task in yesterday_tasks %}
  <div class="w-full h-24 bg-white rounded-lg shadow-sm flex items-center pr-4 pl-3 text-lg font-medium gap-4 mb-5">
    <input type="checkbox" name="task_ids" value="{{ task.id }}" class="task-checkbox custom-checkbox w-15"/>
    <div class="flex-grow">
      <span class="inline-block text-sm font-semibold py-1 px-2 rounded mb-0.5 text-gray-800
            {% if task.category | lower == 'home' %}bg-yellow-200
            {% elif task.category | lower == 'work' %}bg-red-200
            {% else %}bg-gray-200{% endif %}">
        {{ task.category }}
      </span>
      <p class="text-gray-800 leading-tight">
        {{ task.title }}<br/>
        <small class="text-gray-500 font-normal">{{ task.subtask_summary }}</small>
      </p>
    </div>
    <div class="w-2.5 h-full rounded-r-lg ml-auto -mr-4
          {% if task.color == 'red' %}bg-red-500
          {% elif task.color == 'yellow' %}bg-yellow-400
          {% elif task.color == 'gray' %}bg-neutral-400
          {% endif %}">
    </div>
  </div>
  <div class="h-6"></div>
  {% endfor %}
</section>
{% endif %}

{% if not today_tasks and not yesterday_tasks %}
  <p class="text-center text-slate-500 py-10">Nothing in History.</p>
{% endif %}

<!-- checkbox -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const masterCheckbox    = document.querySelector('.master-checkbox');
    const allTaskCheckboxes = document.querySelectorAll('.task-checkbox');
    const allTaskIdsInput   = document.getElementById('all-task-ids');
    const allDeleteIdsInput = document.getElementById('all-delete-ids');

    const updateHiddenInputs = () => {
      const selected = Array.from(allTaskCheckboxes)
                             .filter(cb => cb.checked)
                             .map(cb => cb.value)
                             .join(',');
      if (allTaskIdsInput)   allTaskIdsInput.value   = selected;
      if (allDeleteIdsInput) allDeleteIdsInput.value = selected;
    };

    if (masterCheckbox){
      masterCheckbox.addEventListener('change', () => {
        allTaskCheckboxes.forEach(cb => cb.checked = masterCheckbox.checked);
        updateHiddenInputs();
      });
    }

    allTaskCheckboxes.forEach(cb => {
      cb.addEventListener('change', () => {
        if (masterCheckbox){
          masterCheckbox.checked =
            Array.from(allTaskCheckboxes).every(x => x.checked);
        }
        updateHiddenInputs();
      });
    });

    updateHiddenInputs();
  });
</script>
{% endblock %}